<!-- templates/voice_assistant.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>USSD Voice Assistant</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
.card { border: 1px solid #ddd; padding: 16px; border-radius: 8px; max-width: 720px; margin: auto; }
.status { margin-top: 12px; padding: 8px; background:#f7f7f7; border-radius:6px; }
button { padding:8px 12px; margin:6px; }
#log { height: 220px; overflow:auto; background:#111; color:#fff; padding:10px; border-radius:6px; }
</style>
</head>
<body>
<div class="card">
  <h2>USSD Voice Menu</h2>
  <p>Enter a number: <b>1</b> for Balance, <b>2</b> for Last Transaction, 
     <b>3</b> for Transfer, <b>4</b> to Exit.</p>
  <div>Logged in as user: <strong id="userId">{{ user_id }}</strong></div>

  <div style="margin-top:12px;">
    <input type="number" id="choice" min="1" max="4" placeholder="Enter option (1-4)">
    <button id="submitBtn">Submit</button>
    <a href="/dashboard/{{ user_id }}"><button>Back to Dashboard</button></a>
  </div>

  <div class="status" id="status">Status: idle</div>
  <div id="log"></div>
</div>

<script>
(() => {
const synth = window.speechSynthesis;
const statusEl = document.getElementById('status');
const logEl = document.getElementById('log');
const userId = parseInt(document.getElementById('userId').innerText);
const choiceInput = document.getElementById('choice');
const submitBtn = document.getElementById('submitBtn');

let step = 'main_menu';
let pendingTransfer = { receiver:null, password:null, amount:null };

function log(msg){
  const t=new Date().toLocaleTimeString();
  logEl.innerHTML += `[${t}] ${msg}<br>`;
  logEl.scrollTop = logEl.scrollHeight;
  console.log(msg);
}

function speak(text){
  log('Assistant: ' + text);
  if(!synth) return;
  const ut = new SpeechSynthesisUtterance(text);
  ut.lang = 'en-IN';
  synth.speak(ut);
}

async function handleUSSD(num){
  switch(step){
    case 'main_menu':
      if(num===1) { await checkBalance(); }
      else if(num===2) { await lastTransaction(); }
      else if(num===3) { step='transfer_receiver'; speak('Enter receiver ID as the next number.'); }
      else if(num===4) { speak('Exiting.'); setTimeout(()=>window.location.href=`/dashboard/${userId}`,1000); }
      else { speak('Invalid option. Enter 1, 2, 3 or 4.'); }
      break;

    case 'transfer_receiver':
      pendingTransfer.receiver=num;
      step='transfer_password';
      speak('Enter your password as the next number.');
      break;

    case 'transfer_password':
      pendingTransfer.password=num;
      step='transfer_amount';
      speak('Enter amount to transfer.');
      break;

    case 'transfer_amount':
      pendingTransfer.amount=num;
      await confirmTransfer();
      break;

    case 'transfer_confirm':
      if(num===1){ await doTransfer(); }
      else { speak('Transfer cancelled.'); reset(); }
      break;
  }
}

async function checkBalance(){
  speak('Checking your balance...');
  try{
    const resp = await fetch('/api/voice/check_balance',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({user_id:userId})
    });
    const j = await resp.json();
    if(j.status==='ok') speak(`Your balance is ${j.balance} rupees.`);
    else speak('Unable to fetch balance.');
  } catch(e){ log(e); speak('Network error.'); }
  reset();
}

async function lastTransaction(){
  speak('Fetching your last transaction...');
  try{
    const resp = await fetch('/api/voice/last_transaction',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({user_id:userId})
    });
    const j = await resp.json();
    if(j.status==='ok' && j.transaction){
      const t=j.transaction; 
      const sentOrRecv=(t.sender_id==userId)?'Sent':'Received';
      speak(`${sentOrRecv} ${t.amount} rupees ${sentOrRecv==='Sent'?'to':'from'} user ${sentOrRecv==='Sent'?t.receiver_id:t.sender_id}.`);
    } else { speak('No recent transactions found.'); }
  } catch(e){ log(e); speak('Network error.'); }
  reset();
}

async function confirmTransfer(){
  speak(`Confirm transfer of ${pendingTransfer.amount} rupees to user ${pendingTransfer.receiver}. Enter 1 to confirm, 2 to cancel.`);
  step='transfer_confirm';
}

async function doTransfer(){
  try{
    const payload={sender_id:userId,receiver_id:pendingTransfer.receiver,
                   amount:pendingTransfer.amount,password:pendingTransfer.password};
    const resp=await fetch('/api/voice/transfer',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    const j=await resp.json();
    if(j.status==='ok') speak(j.message);
    else speak('Transfer failed.');
  } catch(e){ log(e); speak('Network error.'); }
  reset();
}

function reset(){
  pendingTransfer={receiver:null,password:null,amount:null};
  step='main_menu';
  speak('Enter 1 for balance, 2 for last transaction, 3 for transfer, 4 to exit.');
}

submitBtn.addEventListener('click', ()=>{
  const num=parseInt(choiceInput.value);
  choiceInput.value='';
  if(!isNaN(num)) handleUSSD(num);
  else speak('Please enter a valid number.');
});

speak('Voice assistant started. Enter 1 for balance, 2 for last transaction, 3 for transfer, 4 to exit.');
})();
</script>

</body>
</html>
